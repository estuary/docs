import:
  - rides.flow.yaml
  - relocations.flow.yaml

collections:
  - name: examples/citi-bike/stations
    key: [/id]
    schema: station.schema.yaml

    derivation:
      transform:
        arrivalAndDeparture:
          source: { name: examples/citi-bike/rides }
          publish:
            nodeJS: |
              return [
                { ...source.end.station, arrival: { ride: 1 } },
                { ...source.begin.station, departure: { ride: 1 } },
              ];
        relocations:
          source: { name: examples/citi-bike/relocations }
          publish:
            nodeJS: |
              return [
                { ...source.to.station, arrival: { move: 1 } },
                { ...source.from.station, departure: { move: 1 } },
              ];

tests:
  "Expect stations update as bikes come and go":
    - ingest:
        collection: examples/citi-bike/rides
        documents:
          # Two bikes leave (from Marin & Newport) and arrive at Harborside.
          - bike_id: &bikeA 8675
            begin:
              station: &Marin { id: 3276, name: "Marin Light Rail" }
              timestamp: &ts "2020-09-01 09:21:12.3090"
            end:
              station: &Harborside { id: 3639, name: "Harborside" }
              timestamp: *ts

          - bike_id: &bikeB 17558
            begin:
              station: &Newport { id: 3202, name: "Newport PATH" }
              timestamp: *ts
            end:
              station: *Harborside
              timestamp: *ts

    - verify:
        collection: examples/citi-bike/stations
        documents:
          - { <<: *Newport, departure: { ride: 1 } }
          - { <<: *Marin, departure: { ride: 1 } }
          - { <<: *Harborside, arrival: { ride: 2 } }

    - ingest:
        collection: examples/citi-bike/rides
        documents:
          # Bike A rides to Marin.
          - bike_id: *bikeA
            begin: { station: *Harborside, timestamp: *ts }
            end: { station: *Marin, timestamp: *ts }
          # Bike B is relocated, and rides from Marin to Newport.
          - bike_id: *bikeB
            begin: { station: *Marin, timestamp: *ts }
            end: { station: *Newport, timestamp: *ts }

    - verify:
        collection: examples/citi-bike/stations
        documents:
          - <<: *Newport
            arrival: { ride: 1 }
            departure: { ride: 1 }
          - <<: *Marin
            arrival: { ride: 1, move: 1 }
            departure: { ride: 2 }
          - <<: *Harborside
            arrival: { ride: 2 }
            departure: { ride: 1, move: 1 }
